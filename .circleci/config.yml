version: 2
jobs:
  build:
    working_directory: ~/curation/data_steward
    parallelism: 1
    shell: /bin/bash --login
    # CircleCI 2.0 does not support environment variables that refer to each other the same way as 1.0 did.
    # If any of these refer to each other, rewrite them so that they don't or see https://circleci.com/docs/2.0/env-vars/#interpolating-environment-variables-to-set-other-environment-variables .
    environment:
      - CIRCLE_ARTIFACTS: /tmp/circleci-artifacts

    docker:
      - image: circleci/python:3.7.4
    steps:
      - checkout:
          path: ~/curation
      - run:
          name: Allow google cloud to be added as apt repo
          command: |
            sudo apt-get update
            sudo apt install software-properties-common
      # Prepare for artifact and test results  collection equivalent to how it was done on 1.0.
      - run: mkdir -p $CIRCLE_ARTIFACTS
      - run:
          name: Add google-cloud-sdk repo to apt
          command: echo "deb http://packages.cloud.google.com/apt cloud-sdk-$(lsb_release -c -s) main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      - run:
          name: Add google key to apt
          command: curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
      - run:
          name: Install google-cloud-sdk
          command: |
            sudo apt-get update
            sudo apt-get install dpkg
            sudo apt-get install google-cloud-sdk
      - run:
          name: Make scripts executable
          command: chmod 700 ./ci/activate_creds.sh && chmod 700 ./ci/setup.sh && chmod 700 ./ci/create_bucket.sh
      - run:
          name: Activate service account
          command: ./ci/activate_creds.sh ${HOME}/gcloud-credentials-key.json
      - run:
          name: Set up environment variables
          command: ./init_env.sh
      - run:
          name: Create buckets and datasets
          command: ./ci/setup.sh
      # Dependencies
      - run:
          name: Add virtual environment activation to bash startup
          command: python3 -m venv ~/curation_venv && echo "source ~/curation_venv/bin/activate" >> $BASH_ENV
      - run:
          name: Upgrade pip and install requirements
          command: |
            pip install --upgrade pip setuptools
            pip install -r requirements.txt
            pip install -r deid/requirements.txt
            pip install -r dev_requirements.txt
      - run:
          name: Show bashrc file
          command: cat ${BASH_ENV}
      # Test
      #   This would typically be a build job when using workflows, possibly combined with build
      - run:
          name: Run unit tests
          working_directory: ~/curation
          command: |
            mkdir -p tests/results/coverage/unit/xml
            mkdir -p tests/results/coverage/unit/html
            mkdir -p tests/results/junit/unit
            ./tests/run_tests.sh -s unit
          no_output_timeout: 300s
          when:  always
      - run:
          name: Run integration tests
          working_directory: ~/curation
          command: |
            t=$(git log -1 --pretty=%B)
            if [[ "$t" == *"all tests"* ]] || [[ ! -z "${CIRCLE_PULL_REQUEST}" ]] || [[ ! -z "${CIRCLE_PULL_REQUESTS}" ]];
            then
                mkdir -p tests/results/coverage/integration/xml
                mkdir -p tests/results/coverage/integration/html
                mkdir -p tests/results/junit/integration
                ./tests/run_tests.sh -s integration
            else
                echo "Skipping integration tests"
            fi
          no_output_timeout: 3000s
      - run:
          name: Comine Coverage Results
          working_directory: ~/curation/tests/results/coverage
          command: |
            mkdir -p all/xml

            # This should happen on pull requests
            if [ -f integration/.coverage ] && [ -f unit/.coverage ];
            then
                echo "Combining integration and unit test results."
                cp integration/.coverage all/.coverage.integration
                cp unit/.coverage all/.coverage.unit
                cd all
                coverage combine .coverage.integration .coverage.unit
                coverage html -d html --title "Curation Python Test Coverage Report - ALL"
                coverage xml -o xml/coverage.xml
                cd -
            fi

            # This will happen for commits, but not pull requests
            if [ ! -f integration/.coverage ] && [ -f unit/.coverage ];
            then
                echo "Providing unit test results only.  Integration tests coverage file not found."
                cp unit/.coverage all/.coverage.unit
                cd all
                coverage combine .coverage.unit
                coverage html -d html --title "Curation Python Test Coverage Report - UNIT"
                coverage xml -o xml/coverage.xml
                cd -
            fi

            # This would be unusual and probably should not happen unless a failure has occurred
            if [ -f integration/.coverage ] && [ ! -f unit/.coverage ];
            then
                echo "Providing integration test results only.  Unit tests coverage file not found."
                cp integration/.coverage all/.coverage.integration
                cd all
                coverage combine .coverage.integration
                coverage html -d html --title "Curation Python Test Coverage Report - INTEGRATION"
                coverage xml -o xml/coverage.xml
                cd -
            fi

            # Likely a test failure occurred
            if [ ! -f integration/.coverage ] && [ ! -f unit/.coverage ];
            then
                echo "No test coverage data available.  Did a test failure occur?"
            fi
          no_output_timeout: 30s
      # Save test results
      - store_test_results:
          path: ~/curation/tests/results/junit
      # Save artifacts
      - store_artifacts:
          path: ~/curation/tests/results/coverage
          destination: test_results
